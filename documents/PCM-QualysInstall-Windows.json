{
  "schemaVersion": "2.2",
  "description": "Download, install, and link a Qualys Agent for Windows.",
  "platformsDetails": {
    "Windows": {}
  },
  "parameters": {
    "CustomerId": {
      "type": "String",
      "description": "The Qualys customer id.",
      "default": "f671c9cf-049d-c280-81c2-6d69f46117a7"
    },
    "ActivationId": {
      "type": "String",
      "description": "The Qualys activation id.",
      "default": "aca503ad-2320-46fa-bf12-2d8490e2e84b"
    },
    "WebServiceUri": {
      "default": "https://qagpublic.qg1.apps.qualys.eu/CloudAgent/",
      "type": "String",
      "description": "The Qualys endpoint for the agent to communicate"
    },
    "DownloadUrl": {
      "type": "String",
      "description": "Location to download the Qualys Agent installer from. Generally the default is appropriate and will get the latest Windows installer.",
      "default": "https://package-manager.pearsoncloudmanagement.com/scanners/qualys/qualys-cloud-agent-windows-x_86_64_latest.exe"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "install",
      "inputs": {
        "runCommand": [
          "$downloadUrl = \"{{DownloadUrl}}\"",
          "$activationID = \"{{ActivationId}}\"",
          "$customerID = \"{{CustomerId}}\"",
          "$webserviceuri = \"{{WebServiceUri}}\"",
          "$filepath = \"C:\\Temp\\qualys-installer.exe\"",
          "$tmp = New-Item -ItemType Directory -Path C:\\Temp -ErrorAction SilentlyContinue",
          "Remove-Item $filepath -ErrorAction SilentlyContinue",
          "try {",
          "    $ProgressPreference = 'silentlyContinue'",
          "    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12",
          "    Invoke-WebRequest -Uri $downloadUrl -OutFile $filepath  -ErrorAction Stop",
          "} catch {",
          "    $ProgressPreference = 'Continue'",
          "    $msg = \"ERROR: Failed to download Qualys Agent Installer with exception: \"",
          "    $msg += $_.Exception.Message",
          "    throw $msg",
          "}",
          "$ProgressPreference = 'Continue'",
          "if (!(Test-Path $filepath -PathType Leaf)) {",
          "    throw \"ERROR: Failed to download Qualys Agent Installer, agent installer not found\"",
          "}",
          "Write-Output \"INFO: Downloaded Qualys Agent Installer\"",
          "try {",
          "    if ( Get-Process QualysAgent -ErrorAction SilentlyContinue) {",
          "        Write-Output \"INFO: Qualys Agent already installed, upgrading\"",
          "        Start-Process $filepath -Wait -ArgumentList \"PatchInstall=TRUE\" -ErrorAction Stop",
          "    } else {",
          "        Write-Output \"INFO: Installing Qualys Agent\"",
          "        Start-Process $filepath -Wait -ArgumentList \"ActivationId={$activationID}\",\"CustomerId={$customerID}\",\"WebServiceUri=$webserviceuri\" -ErrorAction Stop",
          "    }",
          "} catch {",
          "    Remove-Item $filepath -ErrorAction SilentlyContinue",
          "    $msg = \"Error: Failed to install Qualys Agent with exception: \"",
          "    $msg += $_.Exception.Message",
          "    throw $msg ",
          "}",
          "Remove-Item $filepath -ErrorAction SilentlyContinue",
          "$agent = Get-Process QualysAgent -ErrorAction SilentlyContinue",
          "if ($agent) {",
          "    Write-Output $agent",
          "} else {",
          "    throw \"Error: Failed to install Qualys Agent, process QualysAgent not found\"",
          "}"
        ]
      }
    }
  ]
}