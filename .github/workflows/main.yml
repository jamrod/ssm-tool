name: Main CI/CD Pipeline
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Detect which files have changed using reusable workflow
  detect-changes:
    uses: ./.github/workflows/detect-changes.yml
    with:
      patterns: |
        {
          "python": "\\.(py|txt)$|setup\\.cfg",
          "shared-layer": "^infrastructure/ssm_shared_layer\\.py|^layers/",
          "deploy-document": "^infrastructure/ssm_deploy_document_stack\\.py|^lambdas/ssm_deploy_document_tool/|^documents/",
          "parameter-tool": "^infrastructure/ssm_parameter_tool_stack\\.py|^lambdas/ssm_parameter_tool/",
          "run-document": "^infrastructure/ssm_run_document_stack\\.py|^lambdas/ssm_run_document/"
        }

  # Run linting if Python files changed
  lint:
    needs: detect-changes
    if: fromJSON(needs.detect-changes.outputs.results).python == true
    uses: ./.github/workflows/lint.yml

  # Deploy shared layer if it changed
  deploy-shared-layer:
    needs: [detect-changes, lint]
    # Run if shared layer changed, and either linting passed or wasn't needed
    if: |
      always() &&
      fromJSON(needs.detect-changes.outputs.results).shared-layer == true &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    uses: ./.github/workflows/deploy.yml
    with:
      stage: ${{ github.ref == 'refs/heads/main' && 'PRD' || 'DEV' }}
      role_arn: ${{ github.ref == 'refs/heads/main' && 'arn:aws:iam::747207162522:role/PCMCloudAdmin' || 'arn:aws:iam::530786275774:role/PCMCloudAdmin' }}
      stack: SsmSharedLayerStack

  # Deploy document stack
  deploy-document-stack:
    needs: [detect-changes, lint, deploy-shared-layer]
    if: |
      always() &&
      fromJSON(needs.detect-changes.outputs.results).deploy-document == true &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.deploy-shared-layer.result == 'success' || needs.deploy-shared-layer.result == 'skipped')
    uses: ./.github/workflows/deploy.yml
    with:
      stage: ${{ github.ref == 'refs/heads/main' && 'PRD' || 'DEV' }}
      role_arn: ${{ github.ref == 'refs/heads/main' && 'arn:aws:iam::747207162522:role/PCMCloudAdmin' || 'arn:aws:iam::530786275774:role/PCMCloudAdmin' }}
      stack: SsmDeployDocumentStack

  # Deploy parameter tool stack
  deploy-parameter-stack:
    needs: [detect-changes, lint, deploy-shared-layer]
    if: |
      always() &&
      fromJSON(needs.detect-changes.outputs.results).parameter-tool == true &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.deploy-shared-layer.result == 'success' || needs.deploy-shared-layer.result == 'skipped')
    uses: ./.github/workflows/deploy.yml
    with:
      stage: ${{ github.ref == 'refs/heads/main' && 'PRD' || 'DEV' }}
      role_arn: ${{ github.ref == 'refs/heads/main' && 'arn:aws:iam::747207162522:role/PCMCloudAdmin' || 'arn:aws:iam::530786275774:role/PCMCloudAdmin' }}
      stack: SsmParameterToolStack

  # Deploy run document stack
  deploy-run-document-stack:
    needs: [detect-changes, lint, deploy-shared-layer]
    if: |
      always() &&
      fromJSON(needs.detect-changes.outputs.results).run-document == true &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.deploy-shared-layer.result == 'success' || needs.deploy-shared-layer.result == 'skipped')
    uses: ./.github/workflows/deploy.yml
    with:
      stage: ${{ github.ref == 'refs/heads/main' && 'PRD' || 'DEV' }}
      role_arn: ${{ github.ref == 'refs/heads/main' && 'arn:aws:iam::747207162522:role/PCMCloudAdmin' || 'arn:aws:iam::530786275774:role/PCMCloudAdmin' }}
      stack: SsmRunDocumentStack
